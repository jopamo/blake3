name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-fedora-sanitizers:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y \
            clang \
            llvm \
            meson \
            ninja-build \
            git \
            libasan \
            libubsan

      - name: Configure build (Clang + ASan/UBSan)
        run: |
          CC=clang meson setup build-asan \
            -Ddebug_sanitize=true \
            -Dbuildtype=debugoptimized \
            -Dwerror=true

      - name: Build
        run: ninja -C build-asan

      - name: Run tests
        run: |
          # Find where libclang_rt.asan.so is located
          ASAN_LIB_PATH=$(dirname $(find /usr -name libclang_rt.asan.so | head -n 1))
          echo "Found ASan lib at: $ASAN_LIB_PATH"
          export LD_LIBRARY_PATH="$ASAN_LIB_PATH:$LD_LIBRARY_PATH"
          ninja -C build-asan test
